rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ── 헬퍼 함수 ──────────────────────────────────────────
    // teachers/{uid} 문서 존재 여부로 교사 판단
    // students 컬렉션과 완전히 분리하여 권한 상승 공격 방지
    function isTeacher() {
      return request.auth != null &&
        exists(/databases/$(database)/documents/teachers/$(request.auth.uid));
    }

    function isAuthenticated() {
      return request.auth != null;
    }

    // ── teachers ────────────────────────────────────────────
    // 교사 본인만 자신의 문서를 읽을 수 있음 (목록 조회 불가)
    // 쓰기는 서버(Admin SDK) 전용 — 클라이언트에서 직접 교사 등록 불가
    match /teachers/{uid} {
      allow read: if request.auth != null && request.auth.uid == uid;
      allow write: if false; // Admin SDK(서버)만 허용
    }

    // ── teachers_whitelist ──────────────────────────────────
    // 허용된 교사 이메일 목록 — 서버에서만 읽기/쓰기
    match /teachers_whitelist/{docId} {
      allow read: if false;  // 클라이언트 직접 접근 차단, 서버 API 경유
      allow write: if false;
    }

    // ── students ────────────────────────────────────────────
    // 학생 목록은 비로그인(학생 응답 페이지)도 읽을 수 있어야 함
    match /students/{studentId} {
      allow read: if true;
      allow create: if isTeacher();
      allow update: if isTeacher();
      allow delete: if isTeacher();
    }

    // ── massDates ───────────────────────────────────────────
    match /massDates/{massDateId} {
      allow read: if true;
      allow create: if isTeacher();
      allow update: if isTeacher();
      allow delete: if isTeacher();
    }

    // ── availabilities ──────────────────────────────────────
    // 학생 응답 페이지는 비로그인 → 누구나 읽기/쓰기 허용
    match /availabilities/{availabilityId} {
      allow read: if true;
      allow create: if true;
      allow update: if true;
      allow delete: if isTeacher();
    }

    // ── assignments ─────────────────────────────────────────
    // 읽기: 누구나 (학생 일정 조회)
    // 쓰기: 교사만 (AI 배정 결과 저장, 수동 편집)
    match /assignments/{assignmentId} {
      allow read: if true;
      allow create: if isTeacher();
      allow update: if isTeacher();
      allow delete: if isTeacher();
    }

    // ── swapRequests ────────────────────────────────────────
    match /swapRequests/{requestId} {
      allow read: if true;
      allow create: if true;
      allow update: if true;
      allow delete: if isTeacher();
    }

    // ── hymns ───────────────────────────────────────────────
    match /hymns/{hymnId} {
      allow read: if true;
      allow write: if isTeacher();
    }

    // ── massHymns ───────────────────────────────────────────
    match /massHymns/{massHymnId} {
      allow read: if true;
      allow create: if isTeacher();
      allow update: if isTeacher();
      allow delete: if isTeacher();
    }

    // ── messages ────────────────────────────────────────────
    match /messages/{messageId} {
      allow read: if isAuthenticated();
      allow create: if isTeacher();
      allow update: if isTeacher();
      allow delete: if isTeacher();
    }

    // ── hymnAnnouncements ───────────────────────────────────
    // 읽기: 누구나 (학생 성가 안내 조회)
    // 쓰기: 교사만
    match /hymnAnnouncements/{announcementId} {
      allow read: if true;
      allow create: if isTeacher();
      allow update: if isTeacher();
      allow delete: if isTeacher();
    }

    // ── attendance ──────────────────────────────────────────
    // 읽기: 누구나 (교사 대시보드 실시간 onSnapshot 포함)
    // 쓰기: 누구나 허용 (긴급 불참 신고는 비로그인 학생이 API 경유로 기록)
    //       실제 보안은 API Route 레이어에서 처리
    match /attendance/{attendanceId} {
      allow read: if true;
      allow create: if true;
      allow update: if true;
      allow delete: if isTeacher();
    }
  }
}
