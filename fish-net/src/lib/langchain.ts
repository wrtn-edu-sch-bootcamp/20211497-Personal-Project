import { ChatAnthropic } from "@langchain/anthropic";
import { HumanMessage, SystemMessage } from "@langchain/core/messages";

let chatModel: ChatAnthropic | null = null;

function getChatModel(): ChatAnthropic {
  if (!chatModel) {
    chatModel = new ChatAnthropic({
      model: "claude-sonnet-4-20250514",
      anthropicApiKey: process.env.ANTHROPIC_API_KEY,
      maxTokens: 1500,
    });
  }
  return chatModel;
}

// ==================== PDF 원본 기반 역할 가이드 ====================

const ROLE_GUIDES: Record<string, string> = {
  common: `
[공통 전례 예절 — 모든 역할 공통]
미사는 동작 하나하나가 기도입니다. 역할 수행 전 아래 내용을 반드시 숙지하세요.

■ 제대 경례
• 독서대나 해설대로 오를 때와 내려갈 때, 반드시 제대(중앙 제단)를 향해 정중하게 고개를 숙여 인사합니다.
• 이동 중 제대 앞을 지날 때에도 동일하게 경례합니다.
• 경례는 짧고 가볍게가 아니라, 2~3초 정도 진심을 담아 고개를 숙입니다.

■ 복장 규정
• 단정한 복장을 갖추는 것이 기본입니다.
• 너무 짧은 바지, 슬리퍼, 화려한 모자 등은 피해주세요.
• 역할을 맡은 날은 특히 더 신경 써서 입어오는 것을 권장합니다.

■ 이동 방법
• 미사 중 이동할 때는 절대 뛰지 않습니다.
• 천천히, 경건하게 움직이는 것 자체가 기도의 일부입니다.
• 역할을 마친 후에도 조용히, 차분하게 자리로 돌아옵니다.
• 미사는 공연이 아닙니다. 내가 잘 보이는 것보다 함께 기도하는 것이 중요해요.
• 역할 수행 중 실수가 생겨도 당황하지 말고 차분하게 이어가세요.
`,

  reading1: `
[제1독서 + 화답송 가이드]

■ 역할 설명
구약성경 또는 사도행전의 말씀을 회중에게 봉독하고, 이어서 화답송을 선창하는 역할입니다.

■ 준비사항
• 미사 최소 15분 전 도착해서 독서 본문과 화답송을 미리 한 번 읽어볼 것
• 낭독 중 막히는 단어나 지명은 미리 검색해서 발음 확인
• 화답송 후렴구를 미리 숙지해둘 것 (회중이 따라 할 수 있도록 선창해야 함)
• 가능하다면 미사 전례서나 성경 본문을 직접 확인하는 습관 권장 (출력물만 의존 X)
• 단정한 복장 착용
• 물 한 모금 마시고 올라가기 (목 상태 체크)

■ 수행 방법 — 제1독서
이동 및 경례
• 자리에서 일어나 독서대로 이동할 때 제대를 향해 먼저 경례
• 독서대에 도착하면 잠깐 멈추고 회중을 바라본 후 시작

낭독
• 목소리는 평소보다 한 톤 낮고 천천히, 문장 끝에서 살짝 내려가는 톤으로
• 마이크와 입 사이 거리는 주먹 하나 정도 (약 10~15cm)
• 쉼표에서 1박, 마침표에서 2박 쉬는 느낌으로 읽기
• 마지막 문장 읽고 잠깐 멈춘 후: '주님의 말씀입니다'
• 신자들이 '하느님 감사합니다'로 응답할 때까지 독서대에서 머물며 기다리기
• 응답이 끝난 후 화답송으로 이어가기 (바로 내려오지 않기)

시작 멘트: "제1독서. 이사야서 X장 X절~X절"
마무리: "주님의 말씀입니다"
→ 신자 응답: "하느님 감사합니다" (응답이 끝날 때까지 대기)

■ 수행 방법 — 화답송
• 1독서 직후 내려오지 않고 독서대에서 이어서 진행
• 시작 전 잠깐 멈추고 회중이 준비될 수 있도록 여유 주기
• 후렴구를 먼저 선창: '후렴: OOO' 하고 한 번 읽어준 후 회중과 함께 노래 또는 낭독
• 시편 구절은 혼자 읽고, 후렴구는 회중과 함께 반복
• 화답송이 노래일 경우: 반주자와 미리 템포 맞춰두기
• 화답송이 낭독일 경우: 시편 구절을 또렷하고 천천히, 기도하는 톤으로
• 마지막 후렴구까지 마치면 제대를 향해 경례 후 조용히 자리로 돌아오기

■ 자주 하는 실수
• 1독서 끝나고 바로 내려오는 것 → 화답송까지 세트, 응답 끝날 때까지 대기
• 후렴구 선창 없이 바로 시편 구절부터 읽는 것 → 회중이 언제 따라해야 할지 모름
• 화답송 템포를 반주자와 맞추지 않는 것 → 미리 반주자에게 확인
• 너무 빠르게 읽는 것 → 회중이 못 따라옴
• 마이크에 너무 가까이 대는 것 → 잡음 발생
• 내려올 때 제대 경례를 잊는 것 → 항상 제대를 향해 인사

■ 팁
• 화답송 후렴구는 미사 전날 꼭 한 번 읽어두세요
• 긴장되면 크게 숨 한 번 쉬고 시작하세요
• 미사 전례서를 직접 보면 출력물보다 읽기가 훨씬 편해요
`,

  reading2: `
[제2독서 가이드]

■ 역할 설명
신약성경(바오로 서간 등)의 말씀을 봉독하는 역할입니다. 제1독서와 방식은 동일하나 본문 성격이 다릅니다.

■ 준비사항
• 서간문 특성상 문장이 길고 복잡한 경우가 많으니 미리 여러 번 읽어볼 것
• 쉼표, 마침표 위치 미리 파악해서 어디서 끊을지 표시해두기
• 가능하다면 미사 전례서나 성경 본문을 직접 확인하는 습관 권장
• 미사 최소 15분 전 도착
• 단정한 복장 착용

■ 수행 방법
이동 및 경례
• 자리에서 일어나 독서대로 이동할 때 제대를 향해 먼저 경례
• 독서대에 도착하면 잠깐 멈추고 회중을 바라본 후 시작

낭독
• 서간문은 편지 형식이므로 따뜻하고 진지한 톤으로 읽기
• 마이크와 입 사이 거리는 주먹 하나 정도 (약 10~15cm)
• 쉼표에서 1박, 마침표에서 2박 쉬는 느낌으로 읽기
• 마지막: '주님의 말씀입니다'
• 신자들이 '하느님 감사합니다'로 응답할 때까지 독서대에서 머물며 기다리기
• 응답이 끝난 후 제대를 향해 경례하고 자리로 돌아오기

시작 멘트: "제2독서. 로마서 X장 X절~X절"
마무리: "주님의 말씀입니다"
→ 신자 응답: "하느님 감사합니다" (응답이 끝날 때까지 대기)

■ 자주 하는 실수
• 바오로 서간의 긴 문장에서 숨 끊는 위치를 잘못 잡는 것 → 미리 표시해두기
• 제1독서와 톤이 너무 똑같아지는 것 → 조금 더 따뜻한 느낌으로
• 너무 빠르게 읽는 것 → 천천히, 또렷하게
• 신자 응답 전에 바로 내려오는 것 → 응답 끝날 때까지 대기
• 내려올 때 제대 경례를 잊는 것

■ 팁
• 서간문은 편지를 읽는 느낌으로, 따뜻하고 진지하게 읽으세요
• 긴 문장은 미리 어디서 끊을지 연필로 표시해두면 좋아요
`,

  commentary: `
[해설 가이드]

■ 역할 설명
미사 시작 전과 각 순서 사이에 안내 멘트를 하는 역할입니다. 신자들이 언제 일어서고 앉아야 하는지 안내하고,
미사 흐름을 자연스럽게 이어주는 역할이에요.

■ 준비사항
• 해설문 미리 출력하거나 핸드폰에 저장
• 미사 순서 전체 흐름 숙지 (어느 타이밍에 마이크 잡을지)
• 교사 또는 사제에게 특별 공지사항 있는지 미사 전에 확인
• 미사 최소 20분 전 도착
• 단정한 복장 착용

■ 수행 방법
기본 원칙
• 목소리는 밝고 또렷하게, 안내방송 톤으로
• 너무 빠르지 않게, 신자들이 들을 수 있는 속도로
• 모든 멘트 사이사이 2~3초의 침묵을 두어 미사가 급하게 진행되지 않도록 조절
• 항상 다음 순서를 미리 보고 있기 (타이밍 놓치지 않도록)
• 해설대로 이동 시 제대를 향해 경례

일어섬/앉음 안내
• 신자들이 언제 일어서고 앉아야 하는지 명확하게 안내
• 손동작 또는 멘트로 정확히 신호 주기
• 안내 후 2~3초 기다렸다가 다음 멘트로 넘어가기

예시 멘트
• 미사 시작 전: "OO 성당 청소년 주일 미사를 시작하겠습니다. 잠시 후 미사가 시작되오니 핸드폰은 무음으로 해주시기 바랍니다."
• 입당 전 (일어섬 안내): "지금부터 OO 주일 미사를 시작합니다. 모두 일어나 주십시오."
• 독서 전환 시: "이제 제1독서가 있겠습니다."
• 강론 후 앉음 안내: "잠시 묵상하겠습니다. 앉으십시오."

■ 자주 하는 실수
• 긴장해서 목소리가 떨리는 것 → 크게 숨 한 번 쉬고 시작
• 순서를 놓쳐서 타이밍을 늦게 잡는 것 → 항상 다음 순서를 미리 보고 있기
• 멘트를 너무 빨리 읽는 것 → 천천히, 또렷하게
• 침묵 없이 멘트를 이어붙이는 것 → 각 멘트 사이 2~3초 여유
• 일어섬/앉음 안내를 빠뜨리는 것 → 신자들이 혼란스러워함
• 특별 공지사항을 빠뜨리는 것 → 미사 전 교사에게 반드시 확인

■ 팁
• 해설문을 미리 소리 내어 읽어보세요. 낯선 단어가 있으면 미리 확인!
• 미사 순서표를 손에 들고 있으면 타이밍 잡기가 훨씬 편해요
• 침묵은 비어있는 시간이 아니라 기도의 시간이에요. 여유 있게 진행하세요
`,

  accompaniment: `
[반주 가이드]

■ 역할 설명
미사 중 성가 반주를 담당하는 역할입니다. 회중과 성가대가 노래할 수 있도록 리드하되, 반주가 노래 소리를
압도하지 않도록 균형을 맞추는 것이 핵심이에요.

■ 준비사항
• 미사 30분 전 도착해서 악기 세팅 및 음향 체크
• 당일 성가 목록 미리 확인하고 전주 연습
• 처음 연주하는 곡은 최소 전날 연습 필수
• 악보 출력 또는 태블릿 준비 (핸드폰은 화면이 작아서 비추)
• 음향 담당자와 미리 볼륨 체크
• 단정한 복장 착용

■ 수행 방법
기본 원칙
• 전주는 회중이 곡을 인식할 수 있을 만큼 충분히 (최소 1절 전주)
• 템포는 회중이 따라 부를 수 있는 속도로, 너무 빠르게 하지 않기
• 성가대나 선창자가 있으면 그 사람 속도에 맞추기
• 후주는 사제나 해설이 다음 순서로 넘어갈 때까지 이어서 연주

성가대와의 균형
• 악기 볼륨이 노래 소리를 압도하지 않도록 균형 유지가 핵심
• 음향 담당자와 리허설 전 볼륨을 맞추고, 성가대 노래 소리를 들으면서 조절
• 반주는 성가대를 '지지'하는 역할, 반주가 주인공이 되면 안 됨

전례 시기 반영
• 사순 시기 (2026년 2월 말~부활절 전): 화려한 전주나 빠른 템포는 피하고 경건하고 절제된 분위기로 연주
• 대림 시기: 차분하고 기다리는 느낌의 연주
• 부활·성탄 시기: 밝고 기쁨이 넘치는 분위기로 연주
• 연중 시기: 평온하고 차분하게

■ 자주 하는 실수
• 템포가 너무 빨라서 회중이 못 따라오는 것
• 전주 없이 바로 시작하는 것 → 회중이 어떤 곡인지 모름
• 악보 페이지 넘기다 박자 놓치는 것 → 미리 페이지 구성 확인
• 볼륨이 너무 커서 노래 소리를 덮는 것 → 성가대 소리 들으면서 조절
• 전례 시기 분위기를 무시하고 항상 같은 스타일로 연주하는 것

■ 팁
• 성가 목록은 미사 전날 받아두고 미리 연습하세요
• 태블릿에 악보를 넣어두면 페이지 넘기기가 훨씬 편해요
• 사순 시기에는 '덜 화려하게'가 정답이에요. 절제된 연주가 더 아름답습니다
`,

  prayer: `
[보편지향기도 가이드]

■ 역할 설명
보편지향기도(신자들의 기도)를 봉독하는 역할입니다. 교회와 세상을 위해 함께 기도하는 순서예요.

■ 준비사항
• 기도문 미리 출력 또는 저장
• 기도 지향 개수 확인 (보통 4~6개)
• 특별 지향이 있는지 교사에게 미리 확인
• 단정한 복장 착용

■ 수행 방법
• 독서대 또는 지정 위치로 이동 시 제대를 향해 경례
• 목소리는 간절하고 진지한 톤으로, 기도하는 느낌으로
• 너무 빠르지 않게, 각 지향 사이에 1~2초 여유
• 각 지향을 읽은 후 잠깐 멈추면 회중이 응답함
• 마친 후 제대를 향해 경례하고 자리로 돌아오기

예시 멘트
• 시작: "이제 보편 지향 기도를 바치겠습니다."
• 각 지향 후 회중 응답: "주님, 저희의 기도를 들어주소서"
• 마무리: "이 모든 기도를 예수 그리스도를 통하여 드리나이다" (또는 사제가 마무리)

■ 자주 하는 실수
• 회중 응답 타이밍 전에 다음 지향을 읽어버리는 것 → 응답 끝날 때까지 기다리기
• 너무 빠르게 읽어서 기도 분위기가 안 사는 것 → 천천히, 기도하듯이
• 특별 지향 빠뜨리는 것 → 미리 교사 확인 필수
• 이동 시 제대 경례를 빠뜨리는 것

■ 팁
• 기도문을 미리 소리 내어 읽어보면 자연스러운 호흡을 찾을 수 있어요
• 회중이 응답할 때까지 여유 있게 기다리는 게 포인트예요
• 간절한 마음으로 읽으면 회중도 함께 기도하는 분위기가 만들어져요
`,

  massOrder: `
[주일 미사 순서 전체 가이드]

역할 태그 범례: [해설] [독서] [반주] [보편지향기도]

◆ 1부 · 시작 예식
01 입당 성가 [반주]
  사제와 봉사자들이 제대로 입장하는 동안 반주자가 입당 성가를 연주합니다. 사제가 제대에 도착할 때까지 연주를 이어갑니다.

02 인사 및 시작 예식 — 사제
  제대에 입맞춤 후 십자성호와 함께 미사 시작. '주님께서 여러분과 함께' / '또한 사제와 함께'

03 참회 예식 [해설]
  신자들이 '고백합니다'를 바칩니다. 해설자는 '잠시 우리 죄를 반성합시다'를 안내합니다.

04 자비송 (주님 자비를 베푸소서) [반주]
  Kyrie eleison. 사제와 신자가 교창으로 바칩니다.

05 대영광송 (Gloria) [반주]
  주일과 대축일에 노래 또는 낭독합니다. 사순·대림 시기에는 생략합니다.

06 본기도 — 사제
  해당 주일의 본기도. '아멘'으로 응답합니다.

◆ 2부 · 말씀 전례
07 제1독서 [독서]
  구약성경 또는 사도행전 봉독.
  시작: "제1독서. OO권 X장 X절" → 낭독 → "주님의 말씀입니다" → 신자: "하느님 감사합니다"

08 화답송 [독서] [반주]
  독서자가 시편 구절 선창 → 신자들이 후렴구로 응답. 제1독서 직후 독서대에서 이어서 진행.

09 제2독서 [독서]
  신약 서간 봉독.
  시작: "제2독서. OO서간 X장 X절" → 낭독 → "주님의 말씀입니다" → 신자: "하느님 감사합니다"

10 복음 환호송 (알렐루야) [반주]
  사제가 복음 선포 전 알렐루야를 노래합니다. 사순 시기에는 '주님 찬미'로 대체.

11 복음 선포 — 사제/부제
  '주님의 복음입니다' → 신자: '그리스도님 찬미합니다'

12 강론 [해설]
  강론 후 잠시 침묵. 해설자는 강론 후 '잠시 묵상하겠습니다. 앉으십시오.'를 안내합니다.

13 신앙 고백 (신경) — 전체
  사도신경 또는 니케아 신경. '예수님께서 동정녀에게 나시고' 부분에서 고개를 숙입니다.

14 보편 지향 기도 [보편지향기도]
  '이제 보편 지향 기도를 바치겠습니다' → 각 지향 → 신자: '주님, 저희의 기도를 들어주소서' → 마무리

◆ 3부 · 성찬 전례
15 봉헌 및 봉헌 성가 [반주]
  제대 준비 + 예물 봉헌 + 봉헌 성가.

16~17 예물 기도 / 감사송 — 사제

18 거룩하시도다 (Sanctus) [반주]
  고정 성가. '거룩하시도다, 거룩하시도다, 거룩하시도다...'

19 성찬 기도 — 사제
  성찬 제정 말씀. 신자들은 무릎을 꿇거나 깊이 고개를 숙입니다.

20 주님의 기도 — 전체
21 평화 예식 — 전체
22 하느님의 어린양 (Agnus Dei) [반주] — 고정 성가
23 영성체 [반주] — 영성체 성가를 부릅니다.
24 영성체 후 기도 — 사제

◆ 4부 · 마침 예식
25 광고 및 공지 [해설]
  해설자가 본당 공지사항을 안내하는 경우도 있습니다.

26 강복 — 사제
27 파견 및 파견 성가 [반주]
  '미사가 끝났으니 가서 복음을 전합시다' / '하느님 감사합니다' → 파견 성가를 부르며 퇴장.

■ 봉사자 체크포인트
• 해설자: 3·12·25번 순서에서 안내 멘트 준비. 신자 일어섬/앉음도 함께 안내.
• 독서자: 7·8·9번 순서. 화답송까지 세트, 신자 응답 끝날 때까지 독서대에서 대기.
• 반주자: 1·4·5·8·10·15·18·22·23·27번 순서. 사순 시기에는 5번 대영광송 생략.
• 보편지향기도: 14번 순서. 특별 지향 있는지 교사에게 미리 확인.
• 모든 봉사자: 독서대 오를 때·내려올 때 반드시 제대를 향해 경례.
`,

  appGuide: `
[어망(Fish-Net) 앱 사용 가이드]

■ 서비스 개요
어망(Fish-Net)은 병점 성당 중고등부 토요 미사(19:30) 역할 배정을 위한 앱입니다.
교사는 AI 자동 배정과 메시지 전송을 담당하고, 학생은 참석 여부 응답과 배정 확인을 합니다.

■ 메인 화면 (/)
• 이번 달 미사별 학생 응답률을 주차 단위 Progress Bar로 확인할 수 있습니다.
• 다음 미사까지 D-Day 배지로 일정을 한눈에 파악합니다.
• 교사 대시보드(교사용)와 학생 홈(학생용) 카드로 각 영역에 진입합니다.
• 하단 역할 가이드 챗봇에서 추천 질문 또는 직접 입력으로 역할 수행 안내를 받습니다.
• 모든 페이지 우측 하단의 💬 버튼을 눌러 언제든지 챗봇에 질문할 수 있습니다.

■ 교사 대시보드 (/teacher) — 로그인 필요
1. 미사 일정 등록: 날짜와 역할(1독서·2독서·반주·보편지향기도1·2)을 선택 후 등록합니다.
2. AI 자동 배정: "AI 배정 실행" 버튼 클릭 → 학생 가용성·코멘트·이전 배정 이력을 AI가 분석해 정배정·백업1·백업2를 자동 산출합니다.
3. 배정 수동 편집: 배정표 드롭다운에서 담당자를 직접 변경하고 저장합니다.
4. 메시지 생성 및 전송: AI가 각 학생의 역할과 백업 정보가 담긴 카카오톡 메시지 초안을 생성하고, SMS로 즉시 발송할 수 있습니다.

■ 학생 응답 현황 (/teacher/responses) — 교사 전용
• 전체 학생의 응답 상태(가능😊·애매🤔·불가😢·복사단✝️)를 테이블 또는 카드 뷰로 조회합니다.
• 통계 카드: 전체 학생 수 / 응답 완료 / 미응답 / 가능 응답 수 / 애매+불가 수.
• 필터: 전체 / 응답 완료 / 미응답 3가지. 정렬: 이름순 / 응답 수 / 최근 업데이트순.
• 응답 마감일 설정: 날짜 선택 시 저장되고 마감 지남 여부 배지가 자동 표시됩니다.
• 리마인더 SMS: 미응답 학생에게 개별 또는 일괄 리마인더 메시지를 전송합니다.

■ 학생 홈 (/student) — 로그인 불필요
메인 화면에서 학생 홈 카드를 클릭하면 진입합니다. 아래 3가지 메뉴가 있습니다.
• 참석 여부 응답 → /student/response
• 내 역할 배정 확인 → /student/schedule
• 성가 안내 → /student/hymns

■ 참석 여부 응답 (/student/response)
1. 드롭다운에서 본인 이름을 선택합니다. 기존 응답이 있으면 자동으로 불러옵니다.
2. 이번 달 토요일(미사일)마다 "가능해요 / 애매해요 / 못 가요" 중 하나를 선택합니다.
3. "복사단 봉사 있어요" 체크 시 해당 날짜는 자동으로 불참 처리됩니다.
4. 하단 코멘트(선택)에 특이사항을 적으면 AI 배정 시 참고됩니다.
5. "응답 제출하기" 버튼으로 제출합니다. 다른 학생 대리 입력도 가능합니다.
6. 미사 일정이 없으면 "교사가 등록하면 표시됩니다" 안내가 나옵니다.

■ 내 역할 배정 확인 (/student/schedule)
1. 이름과 월을 선택하면 배정 결과가 표시됩니다.
2. 정배정(✦ 앰버 골드 배지)과 백업 배정 섹션으로 분리해서 보여줍니다.
3. 긴급 불참 신고: 정배정 카드 하단 버튼 클릭 → 사유 입력 → 교사에게 즉시 알림 전송.

■ 성가 안내 (/student/hymns)
• 미사 날짜별로 입당·봉헌·영성체·파견 성가의 번호와 제목을 색상별 카드로 확인합니다.
• 6곡 모두 등록된 날짜는 완성 배지가 표시됩니다.
• 미리 확인하여 성가 연습 준비에 활용하세요.
`,

  readingPrinciple: `
[미사 독서 배정의 원칙과 의미]

■ 개요
미사에서 봉독하는 성경 말씀은 임의로 선택된 것이 아닙니다. 1969년 교회가 제정한 「미사 독서 목록 지침」(Ordo Lectionum Missae)에 따라 체계적으로 배정됩니다.

■ 전 세계 공통
• 전 세계 모든 가톨릭 교회는 같은 날 같은 성경 말씀을 듣습니다.
• 오늘 한국에서 읽히는 말씀은 같은 시각 아프리카·유럽·미국의 성당에서도 동일하게 봉독됩니다.
• 이는 전 세계 가톨릭 신자가 하나의 말씀 안에서 일치함을 의미합니다.

■ 독서 배정 일반 원칙
• 전례 시기 반영: 대림(이사야서), 성탄(요한 1서), 부활(사도행전) 등 각 시기 특성에 맞는 성경 배정
• 길이와 가독성: 신자들이 집중해서 들을 수 있도록 적절한 길이 유지
• 구절 생략 기준: 이해하기 너무 어렵거나 전례에 방해가 되는 구절은 생략하기도 함

■ 주일 및 대축일 독서 — 3년 주기 (가·나·다해)
구성: 제1독서(구약) + 제2독서(서간 또는 요한 묵시록) + 복음
• 주제의 조화: 독서의 주제와 내용이 서로 연결되도록 배치
• 준연속 독서: 성경 본문 순서를 따르되 전례에 적합하지 않은 부분만 생략

복음서 배정:
• 가해 (2023, 2026, ...): 마태오 복음
• 나해 (2024, 2027, ...): 마르코 복음
• 다해 (2025, 2028, ...): 루카 복음
• 공통 (모든 주기): 요한 복음 (특정 전례 시기)

■ 평일 독서 — 2년 주기
• 독서 1개(구약 또는 서간) + 복음
• 복음: 매년 같은 본문 반복
• 첫째 독서: 홀수해/짝수해 2년 주기 → 더 폭넓은 성경 말씀을 접하는 효과

■ 현재 전례 시기
• 사순 시기 (2026년 2월~4월): 회개와 쇄신의 주제가 담긴 말씀이 배정됩니다.

■ 봉사자를 위한 실천 팁
• 미사 전날 당일 독서 본문을 미리 찾아 읽어보세요. (가톨릭 굿뉴스 → 매일미사)
• 현재 전례 시기(대림·성탄·사순·부활·연중)를 파악하면 말씀의 맥락이 보입니다.
• 제1독서와 복음의 주제가 어떻게 연결되는지 생각해보며 읽으면 봉독의 깊이가 달라집니다.
• 어려운 지명·인명은 반드시 미사 전에 발음을 확인하세요.
• 미사에 매일 참례할 경우, 3년이면 신·구약 성경의 대부분을 통독하는 효과가 있습니다.
`,
};

// 질문 키워드 → 관련 역할 자동 매핑
const ROLE_KEYWORDS: Record<string, string[]> = {
  reading1: ["1독서", "제1독서", "화답송", "구약", "사도행전", "후렴구", "시편"],
  reading2: ["2독서", "제2독서", "서간", "바오로", "신약", "로마서"],
  commentary: ["해설", "해설자", "안내", "멘트", "공지", "일어서", "앉"],
  accompaniment: ["반주", "피아노", "악기", "성가", "전주", "후주", "템포", "볼륨", "악보"],
  prayer: ["보편지향기도", "보편 지향", "신자들의 기도", "지향", "기도문"],
  common: ["제대 경례", "복장", "이동", "공통", "전례예절"],
  massOrder: ["미사 순서", "미사순서", "순서", "입당", "강론", "영성체", "파견", "봉헌", "강복", "신경", "자비송", "대영광송", "Gloria", "감사송", "참회"],
  readingPrinciple: ["독서 배정", "독서배정", "가해", "나해", "다해", "3년 주기", "전례 시기", "사순", "대림", "부활", "성탄", "연중", "마태오", "마르코", "루카", "요한", "독서 원칙"],
  appGuide: [
    "어망", "fish-net", "fishnet", "앱 사용", "사용법", "어떻게 써", "사용 방법",
    "메인 화면", "진입", "접속",
    "교사 대시보드", "ai 배정", "자동 배정", "배정 실행", "배정 수동", "메시지 생성", "메시지 전송", "카카오톡",
    "응답 현황", "학생 응답", "미응답", "리마인더",
    "참석 응답", "참석 여부", "응답 제출", "이름 선택",
    "복사단 체크", "복사단 봉사",
    "배정 확인", "정배정", "백업 배정", "긴급 불참", "불참 신고",
    "성가 안내", "성가 목록", "성가 확인",
    "챗봇", "질문", "가이드 도우미", "d-day", "응답률", "progress",
  ],
};

/**
 * 질문 텍스트에서 관련 역할을 자동으로 감지합니다.
 * 감지된 역할의 가이드 + 공통 가이드를 반환합니다.
 */
function detectRelevantGuides(question: string): { roles: string[]; context: string } {
  const detected = new Set<string>();

  for (const [role, keywords] of Object.entries(ROLE_KEYWORDS)) {
    if (keywords.some((kw) => question.includes(kw))) {
      detected.add(role);
    }
  }

  // 아무것도 감지 안 되면 전체 가이드 제공
  const roles = detected.size > 0 ? Array.from(detected) : Object.keys(ROLE_GUIDES);

  // 공통 예절은 항상 포함 (already included if detected.size === 0)
  if (!roles.includes("common")) roles.unshift("common");

  const context = roles
    .map((r) => ROLE_GUIDES[r] ?? "")
    .filter(Boolean)
    .join("\n\n---\n\n");

  return { roles, context };
}

// ==================== Public API ====================

/**
 * 역할명을 명시적으로 지정해서 질문할 때 사용 (기존 호환)
 */
export async function answerRoleQuestion(role: string, question: string): Promise<string> {
  const model = getChatModel();
  const guide = ROLE_GUIDES[role] ?? "";
  const commonGuide = ROLE_GUIDES["common"] ?? "";
  const context = [commonGuide, guide].filter(Boolean).join("\n\n---\n\n");

  const messages = [
    new SystemMessage(buildSystemPrompt(context)),
    new HumanMessage(question),
  ];

  const response = await model.invoke(messages);
  return response.content as string;
}

/**
 * 역할을 자동 감지해서 답변 — RAG 챗봇 메인 진입점
 */
export async function answerGuideQuestion(question: string): Promise<string> {
  const model = getChatModel();
  const { context } = detectRelevantGuides(question);

  const messages = [
    new SystemMessage(buildSystemPrompt(context)),
    new HumanMessage(question),
  ];

  const response = await model.invoke(messages);
  return response.content as string;
}

function buildSystemPrompt(context: string): string {
  return `당신은 병점 성당 중고등부 주일학교의 역할 수행 가이드 도우미입니다.
학생들이 미사 역할(제1독서, 제2독서, 해설, 반주, 보편지향기도)을 잘 수행할 수 있도록 안내합니다.

아래는 공식 역할 수행 가이드 원문입니다:

${context}

--- 답변 지침 ---
1. 답변은 반드시 "가이드에 따르면," 또는 "어망 가이드에서는," 으로 시작하세요.
2. 가이드에 있는 구체적인 수행 방법, 예시 멘트, 자주 하는 실수를 적극 인용하세요.
3. 친절하고 따뜻한 톤으로, 중학생·고등학생이 이해하기 쉽게 설명하세요.
4. 가이드에 없는 내용은 "가이드에 명시된 내용은 아니지만,"이라고 먼저 밝히고 답변하세요.
5. 답변은 너무 길지 않게 핵심만 짚어주되, 예시 멘트가 있으면 반드시 인용하세요.`;
}

export async function analyzeDocumentAndAnswer(
  documentContent: string,
  question: string
): Promise<string> {
  const model = getChatModel();

  const messages = [
    new SystemMessage(`당신은 문서 내용을 기반으로 질문에 답변하는 AI 비서입니다.
다음 문서 내용을 참고하여 질문에 답변해주세요:

${documentContent}

문서에 없는 내용은 "문서에서 해당 정보를 찾을 수 없습니다"라고 답변해주세요.`),
    new HumanMessage(question),
  ];

  const response = await model.invoke(messages);
  return response.content as string;
}

export { ROLE_GUIDES };
